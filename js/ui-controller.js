function msg(t,cb,inp=false){$('msgT').innerText=t;$('msgB').innerHTML=inp?`<input id="pmI" type="number" style="margin-bottom:4px;width:100%"><br><button onclick="(${cb})($('pmI').value);$('msgM').classList.remove('active')" style="border-color:var(--gr)">OK</button>`:(cb?`<button onclick="(${cb})();$('msgM').classList.remove('active')" style="border-color:var(--gr)">OK</button><button onclick="$('msgM').classList.remove('active')" style="border-color:var(--re)">Cancel</button>`:`<button onclick="$('msgM').classList.remove('active')">OK</button>`);$('msgM').classList.add('active');if(inp)$('pmI').focus()}
function svSt(){clearTimeout(svT);svT=setTimeout(()=>{const eS={};Object.keys(EM).forEach(k=>eS[k]=$(`c-${k}`).value);const s={tx:$('tx').value,vl:$('vl').value,wi:$('wi').value,ri:$('ri').value,wcM:$('wcM').value,as:$('as').checked,bp:$('bp').checked,tm:document.body.classList.contains('light-mode'),curI,lU:au.src.startsWith('blob')?'':au.src,lT:au.currentTime,exMd,tLim,tEl,st:started,trV:$('trI').value,trO:$('trM').classList.contains('active'),eS,exP:$('exP').value,exT:$('exT').value,exRT:$('exRT').value,exW:$('exW').value,exMM:$('exMM').value,mkPh,mkDur};localStorage.setItem('st',JSON.stringify(s))},1000)}
function ldSt(){try{const s=JSON.parse(localStorage.getItem('st')),h=JSON.parse(localStorage.getItem('hist'));if(h)hist=h;if(s){$('tx').value=s.tx||'';$('vl').value=s.vl||1;$('wi').value=s.wi||'80';$('ri').value=s.ri||'1.0000';$('wcM').value=s.wcM||'0';$('as').checked=!!s.as;$('bp').checked=!!s.bp;curI=s.curI??-1;if(s.tm)document.body.classList.add('light-mode');document.querySelectorAll('.th-chk').forEach(x=>x.checked=!!s.tm);if(s.lU){au.src=s.lU;if(s.lT)au.currentTime=Math.max(0,s.lT-5)}
$('exMode').value=exMd=s.exMd||'prac';tLim=s.tLim||10;$('trI').value=s.trV||'';$('exP').value=s.exP||'def';$('exT').value=s.exT||10;$('exRT').value=s.exRT||5;$('exW').value=s.exW||80;$('exMM').value=s.exMM||100;if(s.eS)Object.keys(EM).forEach(k=>{$(`c-${k}`).value=s.eS[k]||'S'});if(s.trO){opTr();if(s.st){tEl=s.tEl+5;tS=Date.now()-tEl*1000;started=1;stTmr()}}if(exMd==='mock'){mkPh=s.mkPh||0;mkDur=s.mkDur||0;stEx(true)}}}catch(e){}}
function resetData(){$('tx').value='';$('stTitle').innerText='No Audio';if(lastAuSrc)URL.revokeObjectURL(lastAuSrc);lastAuSrc=null;$('wc').value=0;$('st').innerText='Ready';$('trI').value='';$('resBox').style.display='none';$('rS').innerHTML='';upWC();if(is)au.pause();is=0;updatePlBtn();started=0;if(tmr)clearInterval(tmr);$('tmD').disabled=false;$('tmC').disabled=false;played80=0}
function upWC(f=false){const t=$('tx').value.trim(),m=$('wcM').value;let w=0;if(m==0)w=t?t.split(/\s+/).length:0;else if(m==1)w=Math.ceil(t.length/5);else{const p=t.replace(/([\.?!।])/g,' . ').replace(/([,;])/g,' , ').split(/\s+/).filter(x=>x);p.forEach(x=>{if(x==='.')w+=1;else if(x===',')w+=0.5;else if(!x.match(/^[.?!,;।]$/))w+=1})}$('wc').value=w;$('trBtn').disabled=w===0;updateStatus()}
function updateStatus(){$('stWPM').textContent=($('wi').value||0)+' WPM';$('stRate').textContent=($('ri').value||1.0)+'x';$('tm').textContent=`${fT(au.currentTime/au.playbackRate)}/${fT(au.duration/au.playbackRate)}`;}
function init(){let o=document.createElement('option');o.value='All';o.textContent='All';$('rg').appendChild(o);regs.forEach(r=>{let o=document.createElement('option');o.value=r.t;o.textContent=r.n;$('rg').appendChild(o)});lReg('All');[40,50,60,80,90,100,120,140,160,180,200].forEach(v=>{let o=document.createElement('option');o.value=v;o.textContent=v;$('ws').appendChild(o)});[0.8,1,1.2,1.5].forEach(v=>{let o=document.createElement('option');o.value=v;o.textContent=v;$('rs').appendChild(o)});$('f').onchange=async e=>{resetData();for(const f of Array.from(e.target.files)){if(f.type.includes('audio')){lastAuSrc=URL.createObjectURL(f);au.src=lastAuSrc;$('stTitle').innerText=f.name}else if(f.name.match(/\.(txt|md)$/i)||f.type.includes('text')){$('tx').value=await f.text();upWC(true)}}svSt();if(exNext)stEx()};const cH=document.querySelector('.ctrl-grp').innerHTML;$('mdC').innerHTML=cH;$('trC').innerHTML=cH;ldSt();const g=$('exC');Object.keys(EM).forEach((k,i)=>{const d=document.createElement('div');d.className=`eg-i ${i>3?'hd-err':''}`;d.innerHTML=`<label>${EM[k]}</label><select id="c-${k}" onchange="svSt()"><option value="H">H</option><option value="S" ${['SB','MI','IN'].includes(k)?'selected':''}>S</option><option value="D">D</option><option value="X" ${EM[k].includes('Space')?'selected':''}>X</option></select>`;g.appendChild(d)});g.innerHTML+='<div class="more-tg" onclick="document.querySelectorAll(\'.hd-err\').forEach(e=>e.classList.toggle(\'show\'))">Show More/Less</div>';upWC()}
async function lReg(r){try{curL=[];renL();const srcs=r==='All'?regs:regs.filter(x=>x.t===r);for(const s of srcs){const res=await fetch(`https://gist.githubusercontent.com/vs-parihar/${s.u}/raw?t=${Date.now()}`);const j=await res.json();if(Array.isArray(j))curL.push(...j.map(i=>({...i,reg:s.t})));}lD()}catch(e){}}
function setP(v){const[min,max]=v.split('-');uSl('min',min);uSl('max',max==='max'?maxW:max)}
function uSl(t,v){let val=parseInt(v)||0;if(t==='min'){$('wMin').value=val;$('slMi').value=val}else{$('wMax').value=val;$('slMa').value=val}renL()}
function adj(k,v){if(k==='sc'){curS=Math.max(0.5,Math.min(1.5,curS+v));document.documentElement.style.setProperty('--sc',curS)}else{curT=Math.max(10,Math.min(48,curT+v));document.documentElement.style.setProperty('--ts',curT+'px')}}
function openM(){$('md').classList.toggle('active')}
function lD(){maxW=0;curL=curL.map((i,idx)=>{let m=i.title.match(/WORDS\s*(\d+)/i),w=i.w||[],b=Math.max(...w,m?parseInt(m[1]):0);if(b>maxW)maxW=b;return{...i,_id:idx,maxW:b,tags:(i.tags||[]).map(t=>t.toUpperCase())}});$('slMi').max=$('slMi').value=$('slMa').max=$('slMa').value=maxW;uSl('min',0);uSl('max',maxW);renT();renL()}
function renT(){const t=$('tags'),set=new Set();curL.forEach(i=>i.tags.forEach(g=>set.add(g)));t.innerHTML='';Array.from(set).sort().forEach(g=>{let s=document.createElement('span');s.className='filter-chip';s.textContent=g;s.onclick=()=>{s.classList.toggle('active');renL()};t.appendChild(s)})}
function renL(){const mi=parseInt($('wMin').value)||0,ma=parseInt($('wMax').value)||maxW,at=Array.from(document.querySelectorAll('.filter-chip.active')).map(x=>x.textContent),so=$('srt').value,sq=$('libS').value.toLowerCase(),wm=$('wcM').value,map=[1,0,2];filtL=curL.filter(i=>{const v=i.maxW||0;return(v>=mi&&v<=ma)&&(at.length===0||at.every(t=>i.tags.includes(t)))&&(!sq||i.title.toLowerCase().includes(sq))});if(so==='on')filtL.sort((a,b)=>a._id-b._id);else if(so==='no')filtL.sort((a,b)=>b._id-a._id);else if(so==='az')filtL.sort((a,b)=>a.title.localeCompare(b.title));else if(so==='sl')filtL.sort((a,b)=>a.maxW-b.maxW);else if(so==='ls')filtL.sort((a,b)=>b.maxW-a.maxW);
$('ls').innerHTML='';filtL.forEach((i,idx)=>{let d=document.createElement('div');d.className='list-item';d.id='row-'+idx;let id=i.url?.split('details/')[1],hc=hist[id]?` <b style="color:var(--gr)">(${hist[id]})</b>`:'';let wc=i.w?i.w[map[wm]]:i.maxW;d.innerHTML=`<div style="font-weight:500">${i.title}</div><div style="font-size:9px;opacity:0.7">${wc} words • ${fT(i.dur||0)}${hc}</div>`;d.onclick=()=>lA(i,idx);$('ls').appendChild(d)})}
async function lA(i,idx){curI=idx;curO=i;$('md').classList.remove('active');$('tx').value="Loading...";played80=0;const wm=$('wcM').value,map=[1,0,2],v=i.w?i.w[map[wm]]:i.maxW;if(v){$('wc').value=v;$('st').innerText='W: '+v;if(i.dur){$('wi').value=(fixW>0?fixW:(v/(i.dur/60)).toFixed(2));$('ri').value="1.0000";}}const id=i.url?.split('details/')[1],dl=`https://archive.org/download/${id}/`;let auSrc=i.audio;try{if(id){const mr=await fetch(`https://archive.org/metadata/${id}`).then(r=>r.json()),fs=mr.files||[];const mf=fs.find(f=>f.name.endsWith('.mp3')),of=fs.find(f=>f.name.match(/\.(wav|m4a|ogg|aac)$/i)),tf=fs.find(f=>f.name.endsWith('.txt')||f.name.endsWith('.md'));if(mf)auSrc=dl+mf.name;else if(of)auSrc=dl+of.name;if(i.matter){const r=await fetch(i.matter);$('tx').value=await r.text()}else if(tf){const r=await fetch(dl+tf.name);$('tx').value=await r.text()}else{$('tx').value=mr.metadata.description?.replace(/<[^>]*>?/gm,'')||"No text"}}}catch(e){if(!i.matter)$('tx').value="Text Load Fail"}au.src=auSrc;au.load();$('stTitle').innerText=i.title;upWC();svSt();if(exNext)stEx()}
function tTh(){document.body.classList.toggle('light-mode');let c=document.body.classList.contains('light-mode');document.querySelectorAll('.th-chk').forEach(x=>x.checked=c);svSt()}
function sTm(v){if(v=='-1'){$('tmC').style.display='block';$('tmD').style.display='none';$('tmC').focus()}else{tLim=parseFloat(v);$('tmR').textContent=tLim?fT(tLim*60):"00:00";if(tmr){clearInterval(tmr);tmr=null;started=0;}$('tmR').className='tm-gr';tEl=0;if(v=='-1')tLim=parseFloat($('tmC').value);if(exMd==='mock')$('mkTr').textContent=$('tmR').textContent}}
function stepTrk(n){if(!filtL.length){if(curL.length)filtL=curL;else return}let l=filtL.length;if(!l)return;let x=curI+n;if(x>=0&&x<l)lA(filtL[x],x)}
function tDD(){$('ddF').style.display=$('ddF').style.display==='flex'?'none':'flex'}
function opLnk(){$('lnkM').classList.add('active')}
async function ldLnk(){const u=$('lnkV').value;if(u){$('lnkM').classList.remove('active');resetData();if(u.includes('archive.org')){const id=u.match(/(?:details|metadata)\/([^/?#]+)/)?.[1];if(id){try{const m=await fetch(`https://archive.org/metadata/${id}`).then(r=>r.json()),fs=m.files,mp3=fs.find(x=>x.name.endsWith('.mp3')),txt=fs.find(x=>(x.format==='Text'||x.name.endsWith('.txt'))&&!x.name.includes('_meta'));if(mp3)au.src=`https://archive.org/download/${id}/${mp3.name}`;if(txt)$('tx').value=await fetch(`https://archive.org/download/${id}/${txt.name}`).then(r=>r.text());else if(m.metadata.description)$('tx').value=m.metadata.description.replace(/<[^>]*>?/gm,'');$('stTitle').innerText=m.metadata.title;upWC()}catch(e){msg("Error loading URL")}}}else au.src=u;svSt();if(exNext)stEx()}}
window.onclick=e=>{if(!e.target.matches('.dd-item')&&!e.target.matches('button'))$('ddF').style.display='none'}
$('wi').oninput=()=>sync('w');$('ri').oninput=()=>sync('r');
au.onloadedmetadata=()=>{if(fixW>0&&exMd!=='mock'){const w=parseFloat($('wc').value),m=au.duration/60;if(w&&m){$('wi').value=fixW;$('ri').value=(fixW/(w/m)).toFixed(4);au.playbackRate=parseFloat($('ri').value);updateStatus()}}else sync('r');$('tm').textContent=`${fT(0)}/${fT(au.duration/au.playbackRate)}`;if(exMd==='mock')stEx(true);svSt()}
au.onplay=()=>{is=1;updatePlBtn();if(exMd==='mock'&&mkPh===0){mkPh=1;stMk()}};au.onpause=()=>{is=0;updatePlBtn()};au.onended=()=>{is=0;updatePlBtn();if(exMd==='mock'&&mkPh===1)nxtPh()};
$('pl').onclick=async()=>{if($('pl').disabled)return;if(exMd==='mock'&&mkPh===1)return;if(!ac){ac=new (window.AudioContext||window.webkitAudioContext)();sr=ac.createMediaElementSource(au);gn=ac.createGain();sr.connect(gn);gn.connect(ac.destination);upV()}if(is){au.pause()}else{if($('bp').checked&&au.currentTime<0.5){$('pl').disabled=true;bpAb=new AbortController();try{await beeps(bpAb.signal)}catch(e){$('pl').disabled=false;return}$('pl').disabled=false}if(ac.state==='suspended')await ac.resume();au.play()}updatePlBtn()};
$('sb').onclick=async()=>{if(exMd==='mock'){msg("Exit Exam?",'exitMk');return}if(bpAb)bpAb.abort();au.pause();au.currentTime=0;is=0;updatePlBtn();$('pl').disabled=false};
au.ontimeupdate=()=>{if(!au.duration)return;const d=au.duration,c=au.currentTime,p=(c/d)*100,w=parseFloat($('wi').value)||150,relP=Math.min(100,Math.max(0,c-((20/w)*60))/(d-((40/w)*60))*100);$('pf').style.width=p+'%';$('tm').textContent=`${fT(c/au.playbackRate)}/${fT(d/au.playbackRate)}`;if($('as').checked){const m=$('tx').scrollHeight-$('tx').clientHeight;$('tx').scrollTop=(relP/100)*m}if(c/d>0.8&&curO.url&&!played80){played80=1;let id=curO.url.split('details/')[1];if(!hist[id])hist[id]=0;hist[id]++;localStorage.setItem('hist',JSON.stringify(hist));svSt()}};
$('pb').onclick=e=>{if(exMd==='mock')return;const r=$('pb').getBoundingClientRect();au.currentTime=((e.clientX-r.left)/r.width)*au.duration};
window.onload=init;